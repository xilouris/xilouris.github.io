---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { profile } from '../../data/profile';

// Get all blog posts
const allPosts = await Astro.glob('./*.md');

// Filter out drafts and sort by date (newest first)
const posts = allPosts
  .filter((post) => !post.frontmatter.draft)
  .sort((a, b) => new Date(b.frontmatter.pubDate).valueOf() - new Date(a.frontmatter.pubDate).valueOf());

// Get all unique tags
const allTags = [...new Set(posts.flatMap((post) => post.frontmatter.tags || []))].sort();

// Get posts by year
const postsByYear = posts.reduce((acc, post) => {
  const year = new Date(post.frontmatter.pubDate).getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(post);
  return acc;
}, {} as Record<number, typeof posts>);

const years = Object.keys(postsByYear).sort((a, b) => Number(b) - Number(a));
---

<BaseLayout title="Blog">
  <!-- Blog Header -->
  <section class="bg-gradient-to-br from-primary-50 via-white to-accent-50 py-16 border-b border-secondary-200">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-6xl">
      <h1 class="text-4xl md:text-5xl font-bold text-secondary-900 mb-6 text-center">
        Research Blog
      </h1>
      <p class="text-lg text-secondary-700 text-center max-w-3xl mx-auto mb-8">
        Insights and perspectives on network technologies, cybersecurity, research methodologies, and the evolving landscape of 5G/6G networks.
      </p>

      <!-- Statistics -->
      <div class="grid grid-cols-2 md:grid-cols-3 gap-4 max-w-3xl mx-auto">
        <div class="bg-white rounded-lg p-6 text-center shadow-sm border border-secondary-200">
          <div class="text-3xl font-bold text-primary-700 mb-2">{posts.length}</div>
          <div class="text-sm text-secondary-600">Total Posts</div>
        </div>
        <div class="bg-white rounded-lg p-6 text-center shadow-sm border border-secondary-200">
          <div class="text-3xl font-bold text-accent-700 mb-2">{allTags.length}</div>
          <div class="text-sm text-secondary-600">Topics</div>
        </div>
        <div class="bg-white rounded-lg p-6 text-center shadow-sm border border-secondary-200 col-span-2 md:col-span-1">
          <div class="text-3xl font-bold text-primary-700 mb-2">{years[0]}</div>
          <div class="text-sm text-secondary-600">Latest Year</div>
        </div>
      </div>
    </div>
  </section>

  <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-6xl py-16">
    <!-- Filters -->
    <div class="mb-12">
      <!-- Tag Filter -->
      <div class="mb-6">
        <h3 class="text-sm font-bold text-secondary-900 mb-3 uppercase tracking-wide">Filter by Topic</h3>
        <div class="flex flex-wrap gap-2">
          <button
            class="filter-btn px-4 py-2 rounded-lg font-medium transition-all duration-200 text-sm active"
            data-tag="all"
          >
            All Posts
          </button>
          {allTags.map((tag) => (
            <button
              class="filter-btn px-4 py-2 rounded-lg font-medium transition-all duration-200 text-sm"
              data-tag={tag}
            >
              #{tag}
            </button>
          ))}
        </div>
      </div>

      <!-- Search -->
      <div class="relative max-w-md">
        <input
          type="text"
          id="search-input"
          placeholder="Search posts..."
          class="w-full px-4 py-3 pl-12 rounded-lg border border-secondary-300 focus:border-primary-500 focus:ring-2 focus:ring-primary-200 outline-none transition-all"
        />
        <svg
          class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>
    </div>

    <!-- Blog Posts -->
    <div id="blog-posts" class="space-y-8">
      {posts.map((post) => {
        const { title, description, pubDate, tags = [] } = post.frontmatter;
        const formattedDate = new Date(pubDate).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        const tagString = tags.join(',');
        const searchText = `${title} ${description} ${tags.join(' ')}`.toLowerCase();

        return (
          <article
            class="blog-post bg-white rounded-lg border border-secondary-200 shadow-sm hover:shadow-lg transition-all duration-300 overflow-hidden group"
            data-tags={tagString}
            data-search-text={searchText}
          >
            <div class="p-8">
              <!-- Date Badge -->
              <div class="flex items-center gap-2 text-sm text-secondary-600 mb-4">
                <svg class="w-5 h-5 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <time datetime={pubDate}>{formattedDate}</time>
              </div>

              <!-- Title -->
              <h2 class="text-2xl font-bold text-secondary-900 mb-3 group-hover:text-primary-600 transition-colors">
                <a href={post.url} class="no-underline">
                  {title}
                </a>
              </h2>

              <!-- Description -->
              {description && (
                <p class="text-secondary-700 mb-4 leading-relaxed">
                  {description}
                </p>
              )}

              <!-- Tags -->
              {tags.length > 0 && (
                <div class="flex flex-wrap gap-2 mb-4">
                  {tags.map((tag) => (
                    <span class="bg-primary-50 text-primary-800 px-3 py-1 rounded-full text-xs font-medium border border-primary-200">
                      #{tag}
                    </span>
                  ))}
                </div>
              )}

              <!-- Read More -->
              <a
                href={post.url}
                class="inline-flex items-center gap-2 text-primary-600 hover:text-primary-700 font-medium transition-colors group"
              >
                Read More
                <svg class="w-5 h-5 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </a>
            </div>
          </article>
        );
      })}
    </div>

    <!-- No Results Message -->
    <div id="no-results" class="hidden text-center py-16">
      <svg class="w-16 h-16 text-secondary-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <h3 class="text-xl font-semibold text-secondary-900 mb-2">No posts found</h3>
      <p class="text-secondary-600">Try adjusting your filters or search terms</p>
    </div>
  </div>
</BaseLayout>

<script>
  // Filter and search functionality
  const filterButtons = document.querySelectorAll('.filter-btn');
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const blogPosts = document.querySelectorAll('.blog-post');
  const noResults = document.getElementById('no-results');

  let currentTag = 'all';
  let currentSearch = '';

  function filterPosts() {
    let visibleCount = 0;

    blogPosts.forEach((post) => {
      const element = post as HTMLElement;
      const postTags = element.dataset.tags?.split(',') || [];
      const searchText = element.dataset.searchText || '';

      const tagMatch = currentTag === 'all' || postTags.includes(currentTag);
      const searchMatch = searchText.includes(currentSearch.toLowerCase());

      if (tagMatch && searchMatch) {
        element.classList.remove('hidden');
        visibleCount++;
      } else {
        element.classList.add('hidden');
      }
    });

    // Show/hide no results message
    if (noResults) {
      if (visibleCount === 0) {
        noResults.classList.remove('hidden');
      } else {
        noResults.classList.add('hidden');
      }
    }
  }

  // Tag filter buttons
  filterButtons.forEach((button) => {
    button.addEventListener('click', () => {
      filterButtons.forEach((btn) => btn.classList.remove('active'));
      button.classList.add('active');
      currentTag = button.getAttribute('data-tag') || 'all';
      filterPosts();
    });
  });

  // Search input
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      currentSearch = (e.target as HTMLInputElement).value;
      filterPosts();
    });
  }
</script>

<style>
  .filter-btn {
    background: white;
    color: theme('colors.secondary.700');
    border: 1px solid theme('colors.secondary.200');
  }

  .filter-btn:hover {
    background: theme('colors.primary.50');
    color: theme('colors.primary.700');
    border-color: theme('colors.primary.300');
  }

  .filter-btn.active {
    background: theme('colors.primary.600');
    color: white;
    border-color: theme('colors.primary.600');
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
</style>
