---
import BaseLayout from '../layouts/BaseLayout.astro';
import { links, linkCategories, linkStats } from '../data/links';

// Get unique categories in order
const categories = Object.values(linkCategories);

// Get all tags for tag-based discovery
const allTags = [...new Set(links.flatMap((link) => link.tags || []))].sort();

// Count links by category
const categoryCounts = Object.fromEntries(
  Object.keys(linkCategories).map((cat) => [cat, links.filter((l) => l.category === cat).length])
);
---

<BaseLayout title="Links & Resources">
  <!-- Header Section -->
  <section class="bg-gradient-to-br from-primary-50 via-white to-accent-50 py-16 border-b border-secondary-200">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-6xl">
      <h1 class="text-4xl md:text-5xl font-bold text-secondary-900 mb-6 text-center">
        Links & Resources
      </h1>
      <p class="text-lg text-secondary-700 text-center max-w-3xl mx-auto mb-12">
        A curated collection of academic, technical, and professional resources for 5G/6G research, cloud computing, cybersecurity, and network technologies.
      </p>

      <!-- Statistics -->
      <div class="grid grid-cols-2 md:grid-cols-3 gap-4 max-w-3xl mx-auto">
        <div class="bg-white rounded-lg p-6 text-center shadow-sm border border-secondary-200">
          <div class="text-3xl font-bold text-primary-700 mb-2">{linkStats.totalLinks}</div>
          <div class="text-sm text-secondary-600">Resources</div>
        </div>
        <div class="bg-white rounded-lg p-6 text-center shadow-sm border border-secondary-200">
          <div class="text-3xl font-bold text-accent-700 mb-2">{linkStats.totalCategories}</div>
          <div class="text-sm text-secondary-600">Categories</div>
        </div>
        <div class="bg-white rounded-lg p-6 text-center shadow-sm border border-secondary-200 col-span-2 md:col-span-1">
          <div class="text-3xl font-bold text-primary-700 mb-2">⭐ {linkStats.featuredCount}</div>
          <div class="text-sm text-secondary-600">Featured</div>
        </div>
      </div>
    </div>
  </section>

  <div class="container mx-auto px-4 sm:px-6 lg:px-8 max-w-6xl py-16">
    <!-- Filters Section -->
    <div class="mb-12 space-y-6">
      <!-- Search Input -->
      <div class="relative max-w-2xl mx-auto">
        <input
          type="text"
          id="search-input"
          placeholder="Search resources by title, description, or tags..."
          class="w-full px-6 py-3 pl-12 rounded-lg border border-secondary-300 focus:border-primary-500 focus:ring-2 focus:ring-primary-200 outline-none transition-all"
        />
        <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-secondary-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
      </div>

      <!-- Category Filter Buttons -->
      <div>
        <h3 class="text-sm font-bold text-secondary-900 mb-4 uppercase tracking-wide">Filter by Category</h3>
        <div class="flex flex-wrap gap-3">
          <button
            class="category-filter px-4 py-2 rounded-full font-medium transition-all duration-200 text-sm active"
            data-category="all"
          >
            All Resources
          </button>
          {categories.map((cat) => (
            <button
              class="category-filter px-4 py-2 rounded-full font-medium transition-all duration-200 text-sm"
              data-category={cat.name}
            >
              {cat.icon} {cat.name} ({categoryCounts[cat.name]})
            </button>
          ))}
        </div>
      </div>

      <!-- Sort & View Options -->
      <div class="flex flex-col sm:flex-row gap-4 items-center">
        <div class="flex-1 max-w-xs">
          <label for="sort-select" class="text-sm font-medium text-secondary-700 block mb-2">Sort by</label>
          <select
            id="sort-select"
            class="w-full px-4 py-2 rounded-lg border border-secondary-300 focus:border-primary-500 focus:ring-2 focus:ring-primary-200 outline-none transition-all font-medium"
          >
            <option value="featured-first">Featured First</option>
            <option value="alphabetical">A to Z</option>
            <option value="category">By Category</option>
            <option value="most-recent">Most Recent</option>
          </select>
        </div>

        <!-- Results Counter -->
        <div class="text-sm text-secondary-600 font-medium">
          Showing <span id="result-count">{links.length}</span> resources
        </div>
      </div>
    </div>

    <!-- Resources Grid -->
    <div id="resources-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-12">
      {links.map((link) => (
        <article
          class="resource-item bg-white rounded-lg border border-secondary-200 shadow-sm hover:shadow-lg transition-shadow duration-300 overflow-hidden group"
          data-category={link.category}
          data-search-text={`${link.title} ${link.description} ${(link.tags || []).join(' ')}`.toLowerCase()}
          data-featured={link.featured ? 'true' : 'false'}
          data-title={link.title}
        >
          <div class="p-6">
            <!-- Header with Featured Badge -->
            <div class="flex items-start justify-between gap-3 mb-4">
              <div class="flex items-center gap-2 flex-1">
                <span class="text-2xl">
                  {linkCategories[link.category].icon}
                </span>
                <span class="px-3 py-1 rounded-full text-xs font-semibold inline-block bg-primary-100 text-primary-800">
                  {link.category.split('/')[0]}
                </span>
              </div>
              {link.featured && (
                <span class="inline-block bg-gradient-to-r from-yellow-100 to-amber-100 text-amber-800 px-3 py-1 rounded-full text-xs font-bold">
                  ⭐ Featured
                </span>
              )}
            </div>

            <!-- Title (Clickable) -->
            <a
              href={link.url}
              target="_blank"
              rel="noopener noreferrer"
              class="text-xl font-bold text-secondary-900 mb-3 hover:text-primary-600 transition-colors no-underline block"
            >
              {link.title}
            </a>

            <!-- Description -->
            <p class="text-secondary-700 text-base leading-relaxed mb-4">
              {link.description}
            </p>

            <!-- Tags -->
            {link.tags && link.tags.length > 0 && (
              <div class="flex flex-wrap gap-2 mb-6">
                {link.tags.map((tag) => (
                  <span class="bg-secondary-100 text-secondary-700 px-2 py-1 rounded text-xs font-medium">
                    #{tag}
                  </span>
                ))}
              </div>
            )}

            <!-- Visit Button -->
            <a
              href={link.url}
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center gap-2 px-4 py-2 bg-primary-600 text-white rounded-lg font-medium hover:bg-primary-700 transition-colors no-underline"
            >
              Visit Resource
              <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
              </svg>
            </a>
          </div>
        </article>
      ))}
    </div>

    <!-- No Results Message -->
    <div id="no-results" class="hidden text-center py-16">
      <svg class="w-16 h-16 text-secondary-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <h3 class="text-xl font-semibold text-secondary-900 mb-2">No resources found</h3>
      <p class="text-secondary-600 mb-6">Try adjusting your search terms or category filters</p>
      <button
        id="reset-filters"
        class="inline-flex items-center gap-2 px-6 py-3 bg-primary-600 text-white rounded-lg font-medium hover:bg-primary-700 transition-colors"
      >
        Reset Filters
      </button>
    </div>
  </div>
</BaseLayout>

<style>
  .category-filter {
    background: white;
    color: theme('colors.secondary.700');
    border: 1px solid theme('colors.secondary.200');
  }

  .category-filter:hover {
    background: theme('colors.primary.50');
    color: theme('colors.primary.700');
    border-color: theme('colors.primary.300');
  }

  .category-filter.active {
    background: theme('colors.primary.600');
    color: white;
    border-color: theme('colors.primary.600');
    box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
  }

  .resource-item {
    animation: slideIn 0.3s ease-out;
  }

  .resource-item.hidden {
    display: none;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  // DOM Elements
  const categoryFilters = document.querySelectorAll('.category-filter');
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
  const resourceItems = document.querySelectorAll('.resource-item');
  const resourcesGrid = document.getElementById('resources-grid');
  const noResults = document.getElementById('no-results');
  const resultCount = document.getElementById('result-count');
  const resetButton = document.getElementById('reset-filters');

  // Filter state
  let currentCategory = 'all';
  let currentSearchTerm = '';
  let currentSort = 'featured-first';

  // Filter and display resources
  function filterAndSort() {
    let visibleItems: HTMLElement[] = [];

    // Apply filters
    resourceItems.forEach((item) => {
      const element = item as HTMLElement;
      const category = element.dataset.category || '';
      const searchText = element.dataset.searchText || '';
      const isFeatured = element.dataset.featured === 'true';

      // Check category match
      const categoryMatch = currentCategory === 'all' || category === currentCategory;

      // Check search match
      const searchMatch = searchText.includes(currentSearchTerm.toLowerCase());

      // Show/hide item
      if (categoryMatch && searchMatch) {
        element.classList.remove('hidden');
        visibleItems.push(element);
      } else {
        element.classList.add('hidden');
      }
    });

    // Apply sorting
    visibleItems.sort((a, b) => {
      if (currentSort === 'featured-first') {
        const aFeatured = a.dataset.featured === 'true' ? 1 : 0;
        const bFeatured = b.dataset.featured === 'true' ? 1 : 0;
        return bFeatured - aFeatured;
      } else if (currentSort === 'alphabetical') {
        const aTitle = a.dataset.title || '';
        const bTitle = b.dataset.title || '';
        return aTitle.localeCompare(bTitle);
      } else if (currentSort === 'category') {
        const aCategory = a.dataset.category || '';
        const bCategory = b.dataset.category || '';
        return aCategory.localeCompare(bCategory);
      }
      return 0;
    });

    // Update DOM order (re-append in sorted order)
    visibleItems.forEach((item) => {
      resourcesGrid?.appendChild(item);
    });

    // Update results counter and no-results message
    const hasResults = visibleItems.length > 0;
    if (resultCount) resultCount.textContent = visibleItems.length.toString();
    if (noResults) {
      if (hasResults) {
        noResults.classList.add('hidden');
      } else {
        noResults.classList.remove('hidden');
      }
    }
  }

  // Category filter handler
  categoryFilters.forEach((button) => {
    button.addEventListener('click', () => {
      // Update active state
      categoryFilters.forEach((b) => b.classList.remove('active'));
      button.classList.add('active');

      // Update filter and re-run
      currentCategory = button.dataset.category || 'all';
      filterAndSort();
    });
  });

  // Search input handler
  if (searchInput) {
    searchInput.addEventListener('input', (e) => {
      currentSearchTerm = (e.target as HTMLInputElement).value;
      filterAndSort();
    });
  }

  // Sort dropdown handler
  if (sortSelect) {
    sortSelect.addEventListener('change', (e) => {
      currentSort = (e.target as HTMLSelectElement).value;
      filterAndSort();
    });
  }

  // Reset filters button
  if (resetButton) {
    resetButton.addEventListener('click', () => {
      // Reset filters
      currentCategory = 'all';
      currentSearchTerm = '';
      currentSort = 'featured-first';

      // Update UI
      categoryFilters.forEach((b) => b.classList.remove('active'));
      (categoryFilters[0] as HTMLElement).classList.add('active');

      if (searchInput) searchInput.value = '';
      if (sortSelect) sortSelect.value = 'featured-first';

      // Re-run filter
      filterAndSort();
    });
  }

  // Initial filter on page load
  filterAndSort();
</script>
